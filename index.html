<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no,viewport-fit=cover">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="Promille Pro">
<meta name="theme-color" content="#000000">
<title>Promillerechner Pro</title>
<style>
:root{
    --bg:#000000; /* Tiefschwarz f√ºr OLED (Watch) */
    --sf:#1a1a1a;
    --sf2:#2a2a2a;
    --bd:#444444;
    --tx:#ffffff; /* Maximale Lesbarkeit */
    --txd:#ffffff; /* Erh√∂hter Kontrast f√ºr Labels */
    --txm:#aaaaaa;
    --ac:#007aff; /* Apple Blue */
    --gn:#34d399;
    --yw:#fbbf24;
    --rd:#ff453a;
    --r:14px;
    --st:env(safe-area-inset-top,0px);
    --sb:env(safe-area-inset-bottom,0px);
}
*{margin:0;padding:0;box-sizing:border-box}
body{font-family:-apple-system,BlinkMacSystemFont,'SF Pro Display',sans-serif;background:var(--bg);color:var(--tx);-webkit-tap-highlight-color:transparent;user-select:none;font-size:16px;overflow-x:hidden;min-height:100vh}
.app{max-width:430px;margin:0 auto;padding:12px;padding-top:calc(var(--st) + 8px);padding-bottom:calc(var(--sb) + 16px)}
.hdr{display:flex;align-items:center;justify-content:space-between;padding:10px 4px}
.hdr h1{font-size:20px;font-weight:700;display:flex;align-items:center;gap:8px}
.card{background:var(--sf);border:1px solid var(--bd);border-radius:var(--r);padding:14px;margin-bottom:10px}
.hidden{display:none!important}
.bac-d{background:linear-gradient(180deg,var(--sf),#000);border:1px solid var(--bd);border-radius:18px;padding:20px 14px;margin-bottom:10px;text-align:center}
.bac-v{font-size:4rem;font-weight:800;line-height:1;margin-bottom:8px;font-variant-numeric:tabular-nums;color:var(--ac)}
.bac-u{font-size:.4em;color:var(--txm);margin-left:4px}
.badge{display:inline-block;padding:6px 16px;border-radius:20px;font-size:12px;font-weight:700;text-transform:uppercase}
.st-s{background:rgba(52,211,153,0.2);color:var(--gn)}
.st-d{background:rgba(255,69,58,0.2);color:var(--rd)}
.dg{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:10px}
.db{background:var(--sf2);border:1px solid var(--bd);color:var(--tx);border-radius:14px;padding:15px 5px;font-size:15px;font-weight:600;display:flex;flex-direction:column;align-items:center;gap:5px}
.db:active{background:var(--ac)}
.cc{height:220px;margin-bottom:10px;background:var(--sf);border:1px solid var(--bd);border-radius:var(--r);padding:10px;position:relative;touch-action:none}
canvas{width:100%;height:100%;display:block}
input,select{width:100%;background:var(--sf2);border:1px solid var(--bd);color:var(--tx);border-radius:10px;padding:12px;font-size:16px;outline:none}
.disc{font-size:10px;color:var(--txm);margin-top:15px;line-height:1.4;text-align:center}

/* Watch Anpassungen */
@media(max-width:200px){
    .app{padding:4px}
    .bac-v{font-size:2.5rem}
    .db{padding:8px 2px;font-size:12px}
    .cc{height:140px}
}
</style>
</head>
<body>
<div class="app">
    <div class="hdr">
        <h1><span style="color:var(--ac)">‚Ä∞</span> Rechner</h1>
        <button id="btnSettings" style="background:none;border:none;color:var(--tx);font-size:20px">‚öô</button>
    </div>

    <div id="settings" class="card hidden">
        <div style="display:flex;gap:10px;margin-bottom:10px">
            <div style="flex:1"><label style="font-size:11px;color:var(--txm)">KG</label><input type="number" id="inWeight" value="80"></div>
            <div style="flex:1"><label style="font-size:11px;color:var(--txm)">BIOTYP</label><select id="inGender"><option value="male">M (0.68)</option><option value="female">W (0.55)</option></select></div>
        </div>
    </div>

    <div id="bacDisplay" class="bac-d hidden">
        <div class="bac-v" id="bacValue">0.00<span class="bac-u">‚Ä∞</span></div>
        <div id="bacBadge" class="badge">N√ºchtern</div>
        <div style="margin-top:15px;font-size:13px;display:grid;grid-template-columns:1fr 1fr;gap:10px">
            <div style="text-align:left;color:var(--txm)">Abbau bis:<br><span id="soberTime" style="color:var(--tx);font-weight:bold">-</span></div>
            <div style="text-align:right;color:var(--txm)">Peak:<br><span id="peakValue" style="color:var(--tx);font-weight:bold">-</span></div>
        </div>
    </div>

    <div class="dg">
        <button class="db" onclick="addDrink('Bier', 5, 500)"><span>üç∫</span><span>Bier</span></button>
        <button class="db" onclick="addDrink('Wein', 12, 200)"><span>üç∑</span><span>Wein</span></button>
        <button class="db" onclick="addDrink('Shot', 40, 40)"><span>ü•É</span><span>Shot</span></button>
        <button class="db" onclick="addDrink('Custom', 0, 0)" id="btnCustom"><span>‚ûï</span><span>Eigene</span></button>
    </div>

    <div class="cc" id="chartContainer">
        <canvas id="chartCanvas"></canvas>
    </div>

    <div class="disc">
        Werte sind Sch√§tzungen (Widmark). Forensischer Abbau $\beta = 0,15 \, \text{‚Ä∞/h}$. <strong>Keine Fahrfreigabe!</strong>
    </div>
</div>

<script>
"use strict";

let weight = 80, gender = 'male', drinks = [];
const canvas = document.getElementById('chartCanvas');
const ctx = canvas.getContext('2d');
let lastTouchX = null;

// Forensische Konstanten
const ETHANOL_DENSITY = 0.789;
const ELIMINATION_RATE = 0.15; // pro Stunde

function addDrink(name, alc, amt) {
    if (name === 'Custom') {
        alc = parseFloat(prompt("Vol %?", "5"));
        amt = parseFloat(prompt("Menge ml?", "500"));
        if (isNaN(alc) || isNaN(amt)) return;
    }
    drinks.push({ name, alc, amt, time: new Date() });
    update();
}

function calcBAC(atTime) {
    let totalGram = 0;
    let r = gender === 'male' ? 0.68 : 0.55;
    
    // Einfache Kumulierung mit Zeitversatz
    let earliest = drinks.length ? drinks[0].time : atTime;
    let bac = 0;

    drinks.forEach(d => {
        let hoursSince = (atTime - d.time) / 3600000;
        if (hoursSince > 0) {
            let grams = d.amt * (d.alc / 100) * ETHANOL_DENSITY;
            // 15% Resorptionsdefizit (Forensik)
            grams *= 0.85; 
            let drinkBac = grams / (weight * r);
            bac += drinkBac;
        }
    });

    let totalHours = (atTime - earliest) / 3600000;
    if (totalHours > 0) {
        bac -= (totalHours * ELIMINATION_RATE);
    }
    
    return Math.max(0, bac);
}

function update() {
    const now = new Date();
    const cur = calcBAC(now);
    
    document.getElementById('bacDisplay').classList.toggle('hidden', drinks.length === 0);
    document.getElementById('bacValue').innerHTML = cur.toFixed(2) + '<span class="bac-u">‚Ä∞</span>';
    
    const badge = document.getElementById('bacBadge');
    badge.className = 'badge ' + (cur > 0.5 ? 'st-d' : 'st-s');
    badge.innerText = cur > 0.5 ? 'Fahrunt√ºchtig' : 'Sicherer Bereich';

    // Suche Ende (N√ºchternheit)
    let soberDate = new Date(now);
    if (cur > 0) {
        let hoursToZero = cur / ELIMINATION_RATE;
        soberDate.setMinutes(soberDate.getMinutes() + hoursToZero * 60);
        document.getElementById('soberTime').innerText = soberDate.toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'});
    }

    drawChart();
}

function drawChart() {
    const dpr = window.devicePixelRatio || 1;
    const rect = canvas.getBoundingClientRect();
    canvas.width = rect.width * dpr;
    canvas.height = rect.height * dpr;
    ctx.scale(dpr, dpr);

    if (drinks.length === 0) return;

    const w = rect.width;
    const h = rect.height;
    const padding = 30;
    
    const startTime = new Date(drinks[0].time.getTime() - 30 * 60000);
    const endTime = new Date(startTime.getTime() + 8 * 3600000); // 8h Vorschau
    
    const points = [];
    let maxB = 0.5;

    for (let t = startTime.getTime(); t <= endTime.getTime(); t += 900000) {
        let b = calcBAC(new Date(t));
        points.push({ x: t, y: b });
        if (b > maxB) maxB = b;
    }

    const getX = (t) => padding + ((t - startTime) / (endTime - startTime)) * (w - 2 * padding);
    const getY = (b) => (h - padding) - (b / (maxB * 1.2)) * (h - 2 * padding);

    // Grid & High-Contrast Labels
    ctx.strokeStyle = '#444';
    ctx.fillStyle = '#ffffff'; // Wei√ü f√ºr Watch Ultra
    ctx.font = 'bold 10px sans-serif';
    
    // 0.5 Promille Linie (Warnlinie)
    ctx.beginPath();
    ctx.setLineDash([5, 5]);
    ctx.moveTo(padding, getY(0.5));
    ctx.lineTo(w - padding, getY(0.5));
    ctx.strokeStyle = 'rgba(255,69,58,0.5)';
    ctx.stroke();
    ctx.setLineDash([]);
    ctx.fillText("0.5", 5, getY(0.5) + 3);

    // Kurve
    ctx.beginPath();
    ctx.lineWidth = 3;
    ctx.strokeStyle = '#007aff';
    points.forEach((p, i) => {
        if (i === 0) ctx.moveTo(getX(p.x), getY(p.y));
        else ctx.lineTo(getX(p.x), getY(p.y));
    });
    ctx.stroke();

    // Touch-Interaktion (Tooltip)
    if (lastTouchX !== null) {
        const touchT = startTime.getTime() + ((lastTouchX - padding) / (w - 2 * padding)) * (endTime - startTime);
        const touchB = calcBAC(new Date(touchT));
        
        ctx.beginPath();
        ctx.strokeStyle = '#ffffff';
        ctx.moveTo(lastTouchX, padding);
        ctx.lineTo(lastTouchX, h - padding);
        ctx.stroke();

        ctx.fillStyle = '#007aff';
        ctx.beginPath();
        ctx.arc(lastTouchX, getY(touchB), 5, 0, Math.PI * 2);
        ctx.fill();

        ctx.fillStyle = '#ffffff';
        ctx.textAlign = 'center';
        ctx.fillText(touchB.toFixed(2) + "‚Ä∞", lastTouchX, padding - 5);
        ctx.fillText(new Date(touchT).toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'}), lastTouchX, h - 5);
    }
}

// Events
canvas.addEventListener('touchstart', (e) => {
    const rect = canvas.getBoundingClientRect();
    lastTouchX = e.touches[0].clientX - rect.left;
    drawChart();
});
canvas.addEventListener('touchmove', (e) => {
    const rect = canvas.getBoundingClientRect();
    lastTouchX = e.touches[0].clientX - rect.left;
    drawChart();
});
canvas.addEventListener('touchend', () => {
    // lastTouchX = null; // Optional: Tooltip stehen lassen oder ausblenden
    drawChart();
});

document.getElementById('btnSettings').onclick = () => document.getElementById('settings').classList.toggle('hidden');
document.getElementById('inWeight').onchange = (e) => { weight = e.target.value; update(); };
document.getElementById('inGender').onchange = (e) => { gender = e.target.value; update(); };

update();
</script>
</body>
</html>
